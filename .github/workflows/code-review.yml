name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    name: Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            .bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: "**/*.{ts,tsx,js,jsx}"
          files_ignore: |
            node_modules/**
            .next/**
            .git/**

      - name: Run ESLint on changed files
        id: eslint
        if: steps.changed-files.outputs.any_changed == 'true'
        continue-on-error: true
        run: |
          echo "Running ESLint on changed files..."
          echo "${{ steps.changed-files.outputs.all_changed_files }}" > changed_files_list.txt

          # Prepare files for ESLint
          files_to_check=""
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              files_to_check="$files_to_check $file"
            fi
          done < changed_files_list.txt

          if [ -n "$files_to_check" ]; then
            bun run eslint $files_to_check --format json --output-file eslint-report.json || true
            bun run eslint $files_to_check --format stylish 2>&1 | tee eslint-output.txt || true
          fi

      - name: Generate review report
        id: report
        if: steps.changed-files.outputs.any_changed == 'true'
        continue-on-error: true
        run: |
          echo "Generating review report..."

          # Parse ESLint results
          if [ -f eslint-report.json ]; then
            error_count=$(jq '[.[].errorCount] | add' eslint-report.json 2>/dev/null || echo "0")
            warning_count=$(jq '[.[].warningCount] | add' eslint-report.json 2>/dev/null || echo "0")
            file_count=$(jq 'length' eslint-report.json 2>/dev/null || echo "0")

            # Calculate score
            if [ "$error_count" -eq 0 ] && [ "$warning_count" -eq 0 ]; then
              score=100
              grade="A+"
            elif [ "$error_count" -eq 0 ]; then
              score=$((80 - warning_count * 2))
              grade="B"
            else
              score=$((60 - error_count * 5 - warning_count))
              grade="C"
            fi

            if [ $score -lt 0 ]; then
              score=0
            fi

            # Create report JSON using printf
            printf '{"summary":{"overallScore":%s,"grade":"%s","totalFiles":%s,"totalIssues":%s,"critical":%s,"warnings":%s},"eslintReport":"eslint-report.json"}' \
              "$score" "$grade" "$file_count" "$((error_count + warning_count))" "$error_count" "$warning_count" > review-report.json
          else
            # No issues or ESLint failed
            printf '{"summary":{"overallScore":100,"grade":"A+","totalFiles":0,"totalIssues":0,"critical":0,"warnings":0}}' > review-report.json
          fi

      - name: Upload review reports
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: code-review-reports
          path: |
            eslint-report.json
            eslint-output.txt
            review-report.json
          if-no-files-found: ignore

      - name: Post review comment
        if: github.event_name == 'pull_request' && steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report = '';
            let overallScore = 100;
            let fileCount = 0;
            let totalIssues = 0;
            let totalCritical = 0;
            let totalWarnings = 0;
            let grade = 'A+';

            try {
              if (fs.existsSync('review-report.json')) {
                const reviewData = JSON.parse(fs.readFileSync('review-report.json', 'utf8'));
                overallScore = reviewData.summary.overallScore;
                fileCount = reviewData.summary.totalFiles;
                totalIssues = reviewData.summary.totalIssues;
                totalCritical = reviewData.summary.critical;
                totalWarnings = reviewData.summary.warnings;
                grade = reviewData.summary.grade;
              }

              report += `# ğŸ”¬ ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n`;
              report += `## æ€»ä½“è¯„åˆ†\n`;
              report += `- **å¾—åˆ†**: ${overallScore}/100\n`;
              report += `- **ç­‰çº§**: ${grade}\n`;
              report += `- **å®¡æŸ¥æ–‡ä»¶æ•°**: ${fileCount}\n`;
              report += `- **æ€»é—®é¢˜æ•°**: ${totalIssues}\n`;
              report += `- **é”™è¯¯**: ${totalCritical}\n`;
              report += `- **è­¦å‘Š**: ${totalWarnings}\n\n`;

              if (totalCritical > 0) {
                report += `## ğŸš¨ é”™è¯¯\n`;
                report += `æ£€æµ‹åˆ° ${totalCritical} ä¸ªé”™è¯¯ï¼Œå¿…é¡»ä¿®å¤ã€‚\n\n`;
              }

              if (totalWarnings > 0) {
                report += `## âš ï¸ è­¦å‘Š\n`;
                report += `æ£€æµ‹åˆ° ${totalWarnings} ä¸ªè­¦å‘Šï¼Œå»ºè®®ä¿®å¤ã€‚\n\n`;
              }

              if (overallScore >= 90) {
                report += `## âœ… å®¡æŸ¥é€šè¿‡\n`;
                report += `ä»£ç è´¨é‡ä¼˜ç§€ï¼Œå¯ä»¥åˆå¹¶ã€‚\n`;
              } else if (overallScore >= 80) {
                report += `## âœ… å®¡æŸ¥é€šè¿‡\n`;
                report += `ä»£ç è´¨é‡è‰¯å¥½ï¼Œå¯ä»¥åˆå¹¶ã€‚\n`;
              } else if (overallScore >= 60) {
                report += `## ğŸŸ¡ éœ€è¦æ”¹è¿›\n`;
                report += `ä»£ç è´¨é‡å¯ä»¥æ¥å—ï¼Œä½†å»ºè®®ä¿®å¤ä¸»è¦é—®é¢˜ã€‚\n`;
              } else {
                report += `## ğŸ”´ éœ€è¦æ”¹è¿›\n`;
                report += `ä»£ç è´¨é‡éœ€è¦æ”¹è¿›ï¼Œè¯·ä¿®å¤é”™è¯¯åå†åˆå¹¶ã€‚\n`;
              }

              // Try to include ESLint output
              if (fs.existsSync('eslint-output.txt')) {
                const eslintOutput = fs.readFileSync('eslint-output.txt', 'utf8');
                if (eslintOutput.trim()) {
                  report += `\n---\n## ESLint æ£€æŸ¥ç»“æœ\n\n`;
                  const lines = eslintOutput.split('\n').slice(0, 50);
                  report += `\`\`\`\n${lines.join('\n')}\n\`\`\`\n`;
                }
              }

              report += `\n---\n`;
              report += `ğŸ“‹ ä½ å¯ä»¥ä» Artifacts ä¸­ä¸‹è½½å®Œæ•´çš„å®¡æŸ¥æŠ¥å‘Šã€‚`;
            } catch (error) {
              report = `# ğŸ”¬ ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n`;
              report += `âŒ ç”ŸæˆæŠ¥å‘Šæ—¶å‡ºé”™: ${error.message}\n\n`;
              report += `è¯·æŸ¥çœ‹ [Actions æ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) è·å–è¯¦ç»†ä¿¡æ¯ã€‚`;
            }

            const { owner, repo, number } = context.issue;
            const comment = { owner, repo, issue_number: number, body: report };

            try {
              await github.rest.issues.createComment(comment);
            } catch (commentError) {
              console.error('Failed to create comment:', commentError);
            }
