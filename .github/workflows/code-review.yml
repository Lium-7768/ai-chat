name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    name: Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            .bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.{ts,tsx,js,jsx}
          files_ignore: |
            node_modules/**
            .next/**
            .git/**
            .claude/**

      - name: Run code review
        if: steps.changed-files.outputs.any_changed == 'true'
        id: code-review
        continue-on-error: true
        run: |
          echo "Changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

          echo "Creating combined review report for src/ directory..."
          node .claude/skills/code-review/scripts/index.js "src/" --output "combined-review.json"

      - name: Upload review report
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: code-review-report
          path: combined-review.json
          if-no-files-found: ignore

      - name: Post review comment
        if: github.event_name == 'pull_request' && steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report = '';
            let overallScore = 0;
            let fileCount = 0;
            let totalIssues = 0;
            let totalCritical = 0;
            let totalWarnings = 0;

            try {
              if (fs.existsSync('combined-review.json')) {
                const combinedReport = JSON.parse(fs.readFileSync('combined-review.json', 'utf8'));
                overallScore = combinedReport.summary.overallScore || 0;
                fileCount = combinedReport.summary.totalFiles || 0;
                totalIssues = combinedReport.summary.totalIssues || 0;
                totalCritical = combinedReport.summary.critical || 0;
                totalWarnings = combinedReport.summary.warnings || 0;

                report += `# ğŸ”¬ ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n`;
                report += `## æ€»ä½“è¯„åˆ†\n`;
                report += `- **å¾—åˆ†**: ${overallScore}/100\n`;
                report += `- **ç­‰çº§**: ${combinedReport.summary.grade}\n`;
                report += `- **å®¡æŸ¥æ–‡ä»¶æ•°**: ${fileCount}\n`;
                report += `- **æ€»é—®é¢˜æ•°**: ${totalIssues}\n`;
                report += `- **ä¸¥é‡é—®é¢˜**: ${totalCritical}\n`;
                report += `- **è­¦å‘Š**: ${totalWarnings}\n\n`;

                if (totalCritical > 0) {
                  report += `## ğŸš¨ ä¸¥é‡é—®é¢˜\n`;
                  report += `æ£€æµ‹åˆ° ${totalCritical} ä¸ªä¸¥é‡é—®é¢˜ï¼Œå¿…é¡»ä¿®å¤ã€‚\n\n`;
                }

                if (totalWarnings > 0) {
                  report += `## âš ï¸ è­¦å‘Š\n`;
                  report += `æ£€æµ‹åˆ° ${totalWarnings} ä¸ªè­¦å‘Šï¼Œå»ºè®®ä¿®å¤ã€‚\n\n`;
                }

                if (overallScore >= 80) {
                  report += `## âœ… å®¡æŸ¥é€šè¿‡\n`;
                  report += `ä»£ç è´¨é‡è‰¯å¥½ï¼Œå¯ä»¥åˆå¹¶ã€‚\n`;
                } else if (overallScore >= 60) {
                  report += `## ğŸŸ¡ éœ€è¦æ”¹è¿›\n`;
                  report += `ä»£ç è´¨é‡å¯ä»¥æ¥å—ï¼Œä½†å»ºè®®ä¿®å¤ä¸»è¦é—®é¢˜ã€‚\n`;
                } else {
                  report += `## ğŸ”´ éœ€è¦æ”¹è¿›\n`;
                  report += `ä»£ç è´¨é‡éœ€è¦æ”¹è¿›ï¼Œè¯·ä¿®å¤ä¸¥é‡é—®é¢˜åå†åˆå¹¶ã€‚\n`;
                }

                report += `---\n`;
                report += `## è¯¦ç»†å®¡æŸ¥ç»“æœ\n\n`;

                combinedReport.files.forEach(fileReport => {
                  if (fileReport.file && !fileReport.file.error) {
                    report += `### ${fileReport.file.name}\n`;
                    report += `- **å¾—åˆ†**: ${fileReport.summary.overallScore}/100 (${fileReport.summary.grade})\n`;

                    if (fileReport.details) {
                      Object.keys(fileReport.details).forEach(category => {
                        const detail = fileReport.details[category];
                        if (detail.issues && detail.issues.length > 0) {
                          report += `\n**${category}**: ${detail.score}/100, ${detail.totalIssues} ä¸ªé—®é¢˜\n`;

                          detail.issues.slice(0, 3).forEach(issue => {
                            const icon = issue.severity === 'error' || issue.severity === 'critical' ? 'ğŸ”´' :
                                        issue.severity === 'warn' ? 'ğŸŸ¡' : 'ğŸ”µ';
                            report += `- ${icon} ${issue.message} (Line ${issue.line})\n`;
                            if (issue.suggestion) {
                              report += `  ğŸ’¡ å»ºè®®: ${issue.suggestion}\n`;
                            }
                          });

                          if (detail.issues.length > 3) {
                            report += `  ... è¿˜æœ‰ ${detail.issues.length - 3} ä¸ªé—®é¢˜\n`;
                          }
                        }
                      });
                    }
                    report += `\n`;
                  }
                });
              } else {
                report += `# ğŸ”¬ ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n`;
                report += `âš ï¸ æ— æ³•è¯»å–å®¡æŸ¥æŠ¥å‘Šæ–‡ä»¶ã€‚\n\n`;
                report += `å¯èƒ½çš„åŸå› ï¼š\n`;
                report += `- ä»£ç å®¡æŸ¥è„šæœ¬æ‰§è¡Œå¤±è´¥\n`;
                report += `- æŠ¥å‘Šæ–‡ä»¶æœªç”Ÿæˆ\n\n`;
                report += `è¯·æŸ¥çœ‹ [Actions æ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) è·å–è¯¦ç»†ä¿¡æ¯ã€‚\n`;
                report += `\nä½ ä¹Ÿå¯ä»¥ä» Artifacts ä¸­ä¸‹è½½å®Œæ•´çš„å®¡æŸ¥æŠ¥å‘Šã€‚`;
              }
            } catch (error) {
              report = `# ğŸ”¬ ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n`;
              report += `âŒ ç”ŸæˆæŠ¥å‘Šæ—¶å‡ºé”™: ${error.message}\n\n`;
              report += `è¯·æŸ¥çœ‹ [Actions æ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) è·å–è¯¦ç»†ä¿¡æ¯ã€‚`;
            }

            const { owner, repo, number } = context.issue;
            const comment = { owner, repo, issue_number: number, body: report };

            try {
              await github.rest.issues.createComment(comment);
            } catch (commentError) {
              console.error('Failed to create comment:', commentError);
            }
